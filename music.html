<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music | Mila Baumann</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Gilda+Display&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
  <style>
    :root {
      --bg: rgb(255, 255, 255);
      --darkred: #000000;
      --bigtext: #000000;
      --paper: #fff;
      --ink: #1d1d1f;
      --teal: #420014;
      --lemon: #766102;
      --pink: #b8bfd9;
      --red: #d86e2d;
      --blue: #fdd9cb;

    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--darkred);
      font-family: "Figtree", sans-serif;
      text-transform: uppercase;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Right-side vertical nav */
    .nav {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 1.85rem;
      padding: 0;
      /* remove extra padding so it hugs the corner */
      z-index: 10;
    }


    .btn {
      --size: 110px;
      /* desktop circle size */
      width: var(--size);
      height: var(--size);
      border-radius: 50%;
      display: grid;
      place-items: center;
      text-decoration: none;
      font-family: "Figtree", sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      letter-spacing: 0.08em;
      color: #000;
      background: #ddd;
      transition: transform 200ms ease, box-shadow 200ms ease, opacity 200ms ease;
      border: none;
    }

    .btn:hover,
    .btn:focus-visible {
      transform: rotate(-6deg) scale(1.06);

    }

    /* Individual colors */
    .btn.teal {
      background: var(--teal);
      color: #fff;
    }

    .btn.lemon {
      background: var(--lemon);
      color: #fff;
    }

    .btn.pink {
      background: var(--pink);
    }

    .btn.red {
      background: var(--red);
    }

    .btn.blue {
      background: var(--blue);

    }


    .hero {
      width: 100%;
      padding: 8rem 2rem 2rem;
    }

    .title {
      font-family: "Inter", serif;
      margin-top: -3rem;
      font-size: clamp(3rem, 9vw, 9rem);
      font-weight: 900;
      text-transform: uppercase;
      line-height: 1;
      color: var(--bigtext);
    }

    .container {
      max-width: 1200px;
      margin-left: 1rem;
      gap: 0rem;
      margin-bottom: 3rem;
    }

    .grid {
      display: grid;
      gap: 2rem;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    @media (max-width:900px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width:560px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      display: flex;
      flex-direction: column;
      gap: .6rem;
      cursor: pointer;
      transition: transform .18s, box-shadow .18s, background .18s;


    }

    .card:hover {
      transform: translateY(-2px);

    }

    .thumb {
      position: relative;
      width: 100%;
      aspect-ratio: 3/4;
      overflow: hidden;
      background: var(--paper);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .thumb embed {
      width: 100%;
      height: 100%;
      border: 0;
    }

    .thumb .overlay {
      position: absolute;
      inset: 0;
      background: transparent;
    }

    .title-caption {
      font: 500 1rem/1.35 "Inter", sans-serif;
      color: var(--darkred);
      word-break: break-word;
    }

    /* Book viewer dialog */
    dialog#viewer {
      width: min(1200px, 96vw);
      height: min(88vh, 920px);
      margin-top: 4rem;
      margin-left: 4rem;
      overflow: visible;
      background: var(--bg);
      box-shadow: 0 30px 80px rgba(0, 0, 0, .28);
      opacity: 0;
      transform: scale(.96);
      transition: opacity .18s, transform .18s;
      position: relative;
      border: transparent;
      /* for piece arrows positioning */
    }

    dialog[open]#viewer {
      opacity: 1;
      transform: scale(1);
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, .42);
    }

    .viewer-bar {
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 .75rem;
      background: #fff;

    }

    .viewer-title {
      font: 500 2rem/1 "Inter", sans-serif;
      color: var(--darkred);
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 100%;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .viewer-actions {
      display: flex;
      align-items: center;
      gap: .35rem;
    }

    .act {
      font: 500 1.5rem/1 "Inter", sans-serif;
      background: transparent;
      color: var(--darkred);
      border: 0px;
      padding: .4rem .6rem;
      cursor: pointer;
      transition: background .15s, transform .12s, opacity .15s;
      text-decoration: none;
    }

    .act:hover {
      background: rgba(140, 0, 4, .10);
    }

    .act:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    .viewer-body {
      width: 100%;
      height: calc(100% - 48px);
      background: var(--paper);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Two-page spread */
    .spread {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      width: min(1100px, 94%);
      height: 98%;
      align-items: stretch;
      justify-items: stretch;
      background: var(--paper);
    }

    .page {
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }

    .blank {
      display: flex;
      align-items: center;
      justify-content: center;
      font: 600 .9rem/1 "Inter", sans-serif;
    }

    /* Piece-to-piece big arrows (inside dialog, outside content) */
    .piece-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 46px;
      height: 46px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--darkred);
      cursor: pointer;
      user-select: none;
      font: 900 22px/1 "Inter", sans-serif;
      font-size: 2rem;
      transition: transform .12s, background .12s, opacity .12s;
      z-index: 5;
      background: var(--paper);
      border: 1px solid transparent;
    }

    .piece-arrow:hover {
      transform: translateY(-50%) scale(1.04);
    }

    .piece-arrow.left {
      left: -50px;
    }

    .piece-arrow.right {
      right: -50px;
    }

    /* add this to your CSS (or into the existing .page block) */
    .page {
      background: var(--paper);
    }


    @media (max-width:820px) {
      .spread {
        grid-template-columns: 1fr;
        height: 92%;
      }
    }

    @media (max-width:700px) {
      .nav {
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        top: 0;
        right: 0;
        padding: 1rem;
        margin-top: 0;
        margin-bottom: 22rem;
      }

      .btn {
        font-size: 1rem;
      }

      .hero {
        padding: 4rem 1rem 1rem;
        text-align: center;
      }

      .title {
        margin-top: 10rem;
      }

      .container {
        padding: 0 1rem 2.5rem;
      }

      .piece-arrow {
        display: none;
      }

      /* hide big arrows on very small screens */
    }

    /* =====================  SMALLER SCREENS ONLY  ===================== */
    /* Keep your default desktop look intact. No changes to .nav or .btn. */

    /* 1) Small desktops/laptops: protect content from the right-side nav */
    @media (max-width: 1280px) and (min-width: 701px) {
      :root {
        --nav-safe: 140px;
      }

      /* space for the vertical button stack */
      .hero,
      .container {
        padding-right: var(--nav-safe);
      }

      dialog#viewer {
        margin-right: var(--nav-safe);
      }
    }

    /* 2) Tablets and below: single-page view in a scrollable lightbox */
    @media (max-width: 820px) {

      /* Make the dialog fill the screen and avoid any overlap */
      dialog#viewer {
        width: 100vw;
        height: 100dvh;
        margin: 0;
        border-radius: 0;
      }

      /* Keep the control bar visible while scrolling pages */
      .viewer-bar {
        position: sticky;
        top: 0;
        z-index: 2;
      }

      /* Scroll to navigate long pages instead of relying on arrows */
      .viewer-body {
        height: calc(100dvh - 48px);
        display: block;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        padding: 0 .5rem 1rem;
        background: var(--paper);
      }

      /* Switch to single-page rendering vertically */
      .spread {
        grid-template-columns: 1fr;
        gap: 10px;
        width: 100%;
        height: auto;
        margin: 0 auto;
      }

      .page {
        align-items: flex-start;
      }

      /* Ensure pages scale to screen width and keep aspect ratio */
      canvas {
        max-width: 100%;
        height: auto !important;
      }
    }

    /* 3) Phones: hide big piece-to-piece arrows, keep simple controls */
    @media (max-width: 700px) {

      /* Do not change .nav on mobile; just keep content clear of it via layout above */
      .piece-arrow {
        display: none !important;
      }

      /* remove large arrows inside dialog */

      /* Make tap targets a bit larger for prev/next spread buttons */
      .viewer-actions .act {
        font-size: 1.2rem;
        padding: .6rem .8rem;
      }

      /* One-column grid of score cards */
      .grid {
        grid-template-columns: 1fr;
      }

      /* Keep thumbnails tidy on small screens */
      .thumb {
        aspect-ratio: 3/4;
      }
    }

    /* ==================== SMALLER SCREENS ONLY ==================== */
    @media (max-width: 1024px) {

      /* Full-bleed lightbox — removes margins, white bars, and scale shrink */
      dialog#viewer {
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        border: none;
        border-radius: 0;
        background: var(--paper);
        box-shadow: none;
        transform: none;
        opacity: 1;
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, 0.42);
      }

      /* Keep the top bar fixed and clean */
      .viewer-bar {
        position: sticky;
        top: 0;
        height: 52px;
        padding: 0 0.75rem;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        z-index: 2;
      }

      /* Title aligned left, not under nav */
      .viewer-title {
        font: 600 1.6rem/1 "Inter", sans-serif;
        color: var(--darkred);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70vw;
        margin: 0;
      }

      /* The main area fills the viewport — no extra white space */
      .viewer-body {
        height: calc(100vh - 52px);
        width: 100vw;
        background: var(--paper);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        padding: 0.5rem 0 2rem;
      }

      /* One-page vertical layout for scores */
      .spread {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        width: min(900px, 96vw);
        margin: 0 auto;
      }

      .page {
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--paper);
      }

      canvas {
        width: 100%;
        height: auto !important;
        max-width: 100%;
      }

      /* Hide big side arrows on smaller screens */
      .piece-arrow {
        display: none !important;
      }

      /* Compact nav arrows in the top bar (next/prev spread) */
      .viewer-actions .act {
        font-size: 1.2rem;
        padding: 0.4rem 0.6rem;
      }
    }

    /* ================== FINAL — LIGHTBOX FULLSCREEN FIX ================== */
    @media (max-width: 1024px) {

      dialog#viewer {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        border: none;
        border-radius: 0;
        background: var(--paper);
        box-shadow: none;
        transform: none;
        opacity: 1;
        z-index: 2000;
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, .42);
      }

      /* Fixed title bar */
      .viewer-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 52px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 .75rem;
        border-bottom: 1px solid rgba(0, 0, 0, .06);
        z-index: 2;
      }

      .viewer-title {
        font: 600 1.6rem/1 "Inter", sans-serif;
        color: var(--darkred);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70vw;
        margin: 0;
      }

      /* The body now starts immediately below the bar */
      .viewer-body {
        position: absolute;
        top: 52px;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--paper);
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        display: block;
        /* remove centering grid */
        padding: 0;
        /* eliminate top white margin */
      }

      /* One-page-per-row vertical layout */
      .spread {
        display: block;
        width: 100%;
        margin: 0 auto;
      }

      .page {
        background: var(--paper);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        /* top-align so first page touches top */
        min-height: calc(100vh - 52px);
        overflow: hidden;
      }

      canvas {
        display: block;
        width: 100%;
        height: auto !important;
        max-width: 100%;
        max-height: none;
      }

      /* Hide big arrows */
      .piece-arrow {
        display: none !important;
      }

      .viewer-actions .act {
        font-size: 1.2rem;
        padding: .4rem .6rem;
      }
    }

    /* Phone refinement */
    @media (max-width: 700px) {
      .viewer-bar {
        height: 50px;
        padding: 0 .5rem;
      }

      .viewer-body {
        top: 50px;
      }

      .page {
        min-height: calc(100vh - 50px);
      }
    }
  </style>
</head>

<body>
  <!-- Right-side nav -->

  <nav class="nav" aria-label="Primary">
    <a class="btn teal" href="index.html">Home</a>
    <a class="btn lemon" href="aboutme.html">About</a>
    <a class="btn pink" href="music.html">Scores</a>
    <a class="btn red" href="visual.html">Visual</a>
    <a class="btn blue" href="contact.html">Contact</a>
  </nav>

  <main>
    <section class="hero" aria-labelledby="page-title">
      <h1 id="page-title" class="title">Scores</h1>
    </section>

    <section class="container">
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
  </main>

  <!-- Book-style two-page viewer -->
  <dialog id="viewer" aria-labelledby="viewerHeading">
    <!-- piece-to-piece arrows (prev/next score) -->
    <button class="piece-arrow left" id="piecePrev" aria-label="Previous piece">←</button>
    <button class="piece-arrow right" id="pieceNext" aria-label="Next piece">→</button>

    <div class="viewer-bar">
      <div class="viewer-title" id="viewerHeading">Loading…</div>
      <div class="viewer-actions">
        <button class="act" id="prevBtn" title="Previous spread (←)">←</button>
        <button class="act" id="nextBtn" title="Next spread (→)">→</button>
        <button class="act" id="closeBtn" title="Close">X</button>
      </div>
    </div>
    <div class="edge-nav left" id="edgePrev" aria-label="Previous spread"></div>
    <div class="edge-nav right" id="edgeNext" aria-label="Next spread"></div>


    <div class="viewer-body">
      <div class="spread">
        <div class="page">
          <canvas id="canvasLeft"></canvas>
          <div id="blankLeft" class="blank" hidden></div>
        </div>
        <div class="page">
          <canvas id="canvasRight"></canvas>
          <div id="blankRight" class="blank" hidden></div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

    // Elements
    const gridEl = document.getElementById('grid');

    const viewer = document.getElementById('viewer');
    const viewerHeading = document.getElementById('viewerHeading');

    const closeBtn = document.getElementById('closeBtn');
    const prevBtn = document.getElementById('prevBtn');   // spread prev
    const nextBtn = document.getElementById('nextBtn');   // spread next
    const edgePrev = document.getElementById('edgePrev');
    const edgeNext = document.getElementById('edgeNext');

    edgePrev.addEventListener('click', (e) => {
      if (e.shiftKey) loadPiece(currentIndex - 1);
      else prevSpread();
    });
    edgeNext.addEventListener('click', (e) => {
      if (e.shiftKey) loadPiece(currentIndex + 1);
      else nextSpread();
    });



    const piecePrevBtn = document.getElementById('piecePrev'); // piece prev
    const pieceNextBtn = document.getElementById('pieceNext'); // piece next

    const canvasLeft = document.getElementById('canvasLeft');
    const canvasRight = document.getElementById('canvasRight');
    const blankLeft = document.getElementById('blankLeft');
    const blankRight = document.getElementById('blankRight');

    // State
    let items = [];           // [{file, title, url}]
    let currentIndex = 0;     // which score
    let pdfDoc = null;        // current PDFDocumentProxy
    let leftPage = 1;         // left page number for current spread
    let scale = 1.0;          // zoom scale (relative to "fit")

    // Helpers
    function friendlyTitle(name) {
      let base = name.replace(/\.[^/.]+$/, '');
      base = base.replace(/[_]+/g, ' ').replace(/\s{2,}/g, ' ').trim();
      base = base.replace(/\s*\(full\s*score\)\s*/i, ' (Full Score)');
      base = base.replace(/\bfull\s*score\b/ig, 'Full Score');
      return base;
    }

    function buildCard(item, index) {
      const card = document.createElement('div');
      card.className = 'card';

      const thumb = document.createElement('div');
      thumb.className = 'thumb';

      const emb = document.createElement('embed');
      emb.src = `${item.url}#page=1&view=FitH`;
      emb.type = 'application/pdf';
      thumb.appendChild(emb);

      const overlay = document.createElement('div');
      overlay.className = 'overlay';
      overlay.addEventListener('click', () => openViewer(index));
      thumb.appendChild(overlay);

      const caption = document.createElement('div');
      caption.className = 'title-caption';
      caption.textContent = item.title;

      card.appendChild(thumb);
      card.appendChild(caption);
      return card;
    }

    function renderGrid() {
      gridEl.innerHTML = '';
      items.forEach((it, i) => gridEl.appendChild(buildCard(it, i)));
    }

    // Book layout helpers
    function setSpreadStart(pageNum) {
      if (pageNum <= 1) { leftPage = 0; }           // cover: only right page = 1
      else if (pageNum % 2 === 0) { leftPage = pageNum; } // even left
      else { leftPage = pageNum - 1; }                      // odd -> pair with previous even
    }

    function computeFitScale(viewport, targetCanvas) {
      const maxW = targetCanvas.parentElement.clientWidth;
      const maxH = targetCanvas.parentElement.clientHeight;
      const sW = maxW / viewport.width;
      const sH = maxH / viewport.height;
      return Math.min(sW, sH);
    }

    async function renderPageToCanvas(pdf, pageNumber, canvas, blankDiv) {
      if (pageNumber <= 0 || pageNumber > pdf.numPages) {
        const ctx = canvas.getContext('2d');
        if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.hidden = true;
        blankDiv.hidden = false;
        blankDiv.textContent = ''; // keep white
        return;
      }
      const page = await pdf.getPage(pageNumber);

      const viewport1x = page.getViewport({ scale: 1 });
      const fit = computeFitScale(viewport1x, canvas);
      const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
      const finalScale = fit * scale * dpr;

      const vp = page.getViewport({ scale: finalScale });
      const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
      canvas.width = Math.floor(vp.width);
      canvas.height = Math.floor(vp.height);

      const cssScale = 1 / dpr;
      canvas.style.width = Math.floor(vp.width * cssScale) + 'px';
      canvas.style.height = Math.floor(vp.height * cssScale) + 'px';

      ctx.imageSmoothingEnabled = false;

      await page.render({ canvasContext: ctx, viewport: vp, intent: 'display' }).promise;
      canvas.hidden = false;
      blankDiv.hidden = true;
    }




    async function openViewer(index) {
      if (!viewer.open) viewer.showModal();
      await loadPiece(index);
    }

    function closeViewer() {
      if (viewer.open) viewer.close();
      [canvasLeft, canvasRight].forEach(c => {
        const ctx = c.getContext('2d'); ctx && ctx.clearRect(0, 0, c.width, c.height);
      });
      pdfDoc = null;
    }
    // --- Add this helper ---
    function isSinglePageMode() {
      return window.matchMedia('(max-width:1024px)').matches;
    }

    // --- Replace your loadPiece with this ---
    async function loadPiece(index) {
      currentIndex = (index + items.length) % items.length;
      scale = 1.0;

      const it = items[currentIndex];
      viewerHeading.textContent = it.title;

      pdfDoc = await pdfjsLib.getDocument(it.url).promise;

      if (isSinglePageMode()) {
        // mobile/tablet: start at page 1, no blank cover
        leftPage = 1;
      } else {
        // desktop: keep the traditional cover (blank left, page 1 right)
        leftPage = 0;
      }
      await renderSpread();
    }

    // --- Replace your renderSpread with this ---
    async function renderSpread() {
      if (!pdfDoc) return;

      const leftPageWrap = canvasLeft.parentElement;   // the .page wrapper
      const rightPageWrap = canvasRight.parentElement;

      if (isSinglePageMode()) {
        // hide the left page entirely so no blank block is created
        leftPageWrap.style.display = 'none';

        // render just the "current" page into the right canvas
        const current = (leftPage === 0) ? 1 : leftPage; // safety
        await renderPageToCanvas(pdfDoc, current, canvasRight, blankRight);

      } else {
        // show two-page spread
        leftPageWrap.style.display = '';
        rightPageWrap.style.display = '';

        const leftNum = (leftPage === 0) ? 0 : leftPage;
        const rightNum = (leftPage === 0) ? 1 : leftPage + 1;

        await Promise.all([
          renderPageToCanvas(pdfDoc, leftNum, canvasLeft, blankLeft),
          renderPageToCanvas(pdfDoc, rightNum, canvasRight, blankRight),
        ]);
      }
    }

    // --- Replace your next/prevSpread with this ---
    function nextSpread() {
      if (!pdfDoc) return;

      if (isSinglePageMode()) {
        // advance one page at a time
        if (leftPage === 0) leftPage = 1;
        else leftPage = Math.min(pdfDoc.numPages, leftPage + 1);
      } else {
        // advance two pages (book spread)
        if (leftPage === 0) leftPage = 2;
        else leftPage = Math.min(pdfDoc.numPages - (pdfDoc.numPages % 2 === 0 ? 1 : 0), leftPage + 2);
      }
      renderSpread();
    }

    function prevSpread() {
      if (!pdfDoc) return;

      if (isSinglePageMode()) {
        if (leftPage <= 1) leftPage = 1;
        else leftPage = Math.max(1, leftPage - 1);
      } else {
        if (leftPage === 0) return;
        if (leftPage === 2) leftPage = 0;
        else leftPage = Math.max(2, leftPage - 2);
      }
      renderSpread();
    }

    // --- Keep this so layout switches live when resizing ---
    window.addEventListener('resize', () => { if (viewer.open) renderSpread(); });




    // Events
    closeBtn.addEventListener('click', closeViewer);
    nextBtn.addEventListener('click', nextSpread);
    prevBtn.addEventListener('click', prevSpread);

    pieceNextBtn.addEventListener('click', () => loadPiece(currentIndex + 1));
    piecePrevBtn.addEventListener('click', () => loadPiece(currentIndex - 1));

    viewer.addEventListener('click', (e) => { if (e.target === viewer) closeViewer(); });

    window.addEventListener('keydown', (e) => {
      if (!viewer.open) return;
      if (e.key === 'Escape') closeViewer();

      // Spread nav
      if (e.key === 'ArrowRight' && !e.shiftKey) nextSpread();
      if (e.key === 'ArrowLeft' && !e.shiftKey) prevSpread();

      // Piece nav with Shift + Arrow
      if (e.key === 'ArrowRight' && e.shiftKey) loadPiece(currentIndex + 1);
      if (e.key === 'ArrowLeft' && e.shiftKey) loadPiece(currentIndex - 1);

      // Zoom
      if (e.key === '+') { scale = Math.min(3, scale + 0.1); renderSpread(); }
      if (e.key === '-') { scale = Math.max(0.3, scale - 0.1); renderSpread(); }
    });

    window.addEventListener('resize', () => { if (viewer.open) renderSpread(); });

    // Load list of scores
    async function init() {
      try {
        const res = await fetch('scores.json');
        const data = await res.json();
        items = (data.scores || []).map(file => ({
          file,
          title: friendlyTitle(file),
          url: `scores/${encodeURI(file)}`
        }));
        renderGrid();
      } catch (err) {
        gridEl.innerHTML = '<p style="color:#300;padding:1rem;background:rgba(255,255,255,.25);border-radius:8px;">Could not load scores.json.</p>';
        console.error(err);
      }
    }
    init();
  </script>
</body>

</html>