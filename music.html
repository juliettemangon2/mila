<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music | Mila Baumann</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Gilda+Display&display=swap"
    rel="stylesheet" />

  <style>
    :root {
      --red: rgb(205, 223, 236);
      --darkred: #5c2f5f;
      --bigtext: #5c2f5f;
      --paper: #fff;
      --ink: #1d1d1f;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      background: var(--red);
      color: var(--darkred);
      font-family: "Gilda Display", serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Right-side vertical nav */
    .nav {
      position: absolute;
      inset-block: 0;
      right: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-end;
      gap: 1rem;
      padding: 2rem;
      margin-top: -28rem;
      z-index: 3;
    }

    .btn {
      font-size: 2.3rem;
      font-weight: 700;
      text-decoration: none;
      color: var(--darkred);
      transition: opacity .2s, transform .2s;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      font-family: "Gilda Display", serif;
    }

    .btn:hover {
      opacity: .7;
      transform: translateX(-3px);
    }

    .hero {
      width: 100%;
      padding: 8rem 2rem 2rem;
    }

    .title {
      font-family: "Inter", serif;
      margin-top: -3rem;
      font-size: clamp(3rem, 9vw, 9rem);
      font-weight: 900;
      text-transform: uppercase;
      line-height: 1;
      color: var(--bigtext);
    }

    .container {
      max-width: 1280px;
      margin-left: 1rem;
      gap: 0rem;
      margin-bottom: 3rem;
    }

    .grid {
      display: grid;
      gap: 2rem;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    @media (max-width:900px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width:560px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      display: flex;
      flex-direction: column;
      gap: .6rem;
      cursor: pointer;
      transition: transform .18s, box-shadow .18s, background .18s;

    }

    .card:hover {
      transform: translateY(-2px);

    }

    .thumb {
      position: relative;
      width: 100%;
      aspect-ratio: 3/4;
      overflow: hidden;
      background: var(--paper);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mila {
      position: fixed;
      bottom: 1%;
      right: 3%;
      transform: translateY(-25%) translateX(50%);
      /* centers vertically + rotates */
      width: 50px;
      /* adjust size as needed */
      height: auto;
      z-index: -1;
      /* keeps it behind your text/nav */
      opacity: 1.0;
      /* optional: makes it blend with background */

    }

    .thumb embed {
      width: 100%;
      height: 100%;
      border: 0;
    }

    .thumb .overlay {
      position: absolute;
      inset: 0;
      background: transparent;
    }

    .title-caption {
      font: 500 1rem/1.35 "Inter", sans-serif;
      color: var(--darkred);
      word-break: break-word;
    }

    /* Book viewer dialog */
    dialog#viewer {
      width: min(1200px, 96vw);
      height: min(88vh, 920px);
      margin-top: 4rem;
      margin-left: 4rem;
      overflow: visible;
      background: var(--red);
      box-shadow: 0 30px 80px rgba(0, 0, 0, .28);
      opacity: 0;
      transform: scale(.96);
      transition: opacity .18s, transform .18s;
      position: relative;
      border: transparent;
      /* for piece arrows positioning */
    }

    dialog[open]#viewer {
      opacity: 1;
      transform: scale(1);
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, .42);
    }

    .viewer-bar {
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 .75rem;
      background: #fff;

    }

    .viewer-title {
      font: 500 2rem/1 "Inter", sans-serif;
      color: var(--darkred);
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 100%;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .viewer-actions {
      display: flex;
      align-items: center;
      gap: .35rem;
    }

    .act {
      font: 500 1.5rem/1 "Inter", sans-serif;
      background: transparent;
      color: var(--darkred);
      border: 0px;
      padding: .4rem .6rem;
      cursor: pointer;
      transition: background .15s, transform .12s, opacity .15s;
      text-decoration: none;
    }

    .act:hover {
      background: rgba(140, 0, 4, .10);
    }

    .act:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    .viewer-body {
      width: 100%;
      height: calc(100% - 48px);
      background: var(--paper);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Two-page spread */
    .spread {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      width: min(1100px, 94%);
      height: 98%;
      align-items: stretch;
      justify-items: stretch;
      background: var(--paper);
    }

    .page {
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }

    .blank {
      display: flex;
      align-items: center;
      justify-content: center;
      font: 600 .9rem/1 "Inter", sans-serif;
    }

    /* Piece-to-piece big arrows (inside dialog, outside content) */
    .piece-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 46px;
      height: 46px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--darkred);
      cursor: pointer;
      user-select: none;
      font: 900 22px/1 "Inter", sans-serif;
      font-size: 2rem;
      transition: transform .12s, background .12s, opacity .12s;
      z-index: 5;
      background: var(--paper);
      border: 1px solid transparent;
    }

    .piece-arrow:hover {
      transform: translateY(-50%) scale(1.04);
    }

    .piece-arrow.left {
      left: -50px;
    }

    .piece-arrow.right {
      right: -50px;
    }

    /* add this to your CSS (or into the existing .page block) */
    .page {
      background: var(--paper);
    }


    @media (max-width:820px) {
      .spread {
        grid-template-columns: 1fr;
        height: 92%;
      }
    }

    @media (max-width:700px) {
      .nav {
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        top: 0;
        right: 0;
        padding: 1rem;
        margin-top: 0;
        margin-bottom: 22rem;
      }

      .btn {
        font-size: 1rem;
      }

      .hero {
        padding: 4rem 1rem 1rem;
        text-align: center;
      }

      .title {
        margin-top: 10rem;
      }

      .container {
        padding: 0 1rem 2.5rem;
      }

      .piece-arrow {
        display: none;
      }

      /* hide big arrows on very small screens */
    }
  </style>
</head>

<body>
  <!-- Right-side nav -->

  <nav class="nav" aria-label="Primary">
    <a class="btn" href="index.html">Home</a>
    <a class="btn" href="aboutme.html">About Me</a>
    <a class="btn" href="music.html">Scores</a>
    <a class="btn" href="visual.html">Visual</a>
    <a class="btn" href="contact.html">Contact</a>
  </nav>

  <main>
    <section class="hero" aria-labelledby="page-title">
      <h1 id="page-title" class="title">Scores</h1>
    </section>

    <section class="container">
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
  </main>

  <!-- Book-style two-page viewer -->
  <dialog id="viewer" aria-labelledby="viewerHeading">
    <!-- piece-to-piece arrows (prev/next score) -->
    <button class="piece-arrow left" id="piecePrev" aria-label="Previous piece">←</button>
    <button class="piece-arrow right" id="pieceNext" aria-label="Next piece">→</button>

    <div class="viewer-bar">
      <div class="viewer-title" id="viewerHeading">Loading…</div>
      <div class="viewer-actions">
        <button class="act" id="prevBtn" title="Previous spread (←)">←</button>
        <button class="act" id="nextBtn" title="Next spread (→)">→</button>
        <button class="act" id="closeBtn" title="Close">X</button>
      </div>
    </div>
    <div class="edge-nav left" id="edgePrev" aria-label="Previous spread"></div>
    <div class="edge-nav right" id="edgeNext" aria-label="Next spread"></div>


    <div class="viewer-body">
      <div class="spread">
        <div class="page">
          <canvas id="canvasLeft"></canvas>
          <div id="blankLeft" class="blank" hidden></div>
        </div>
        <div class="page">
          <canvas id="canvasRight"></canvas>
          <div id="blankRight" class="blank" hidden></div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

    // Elements
    const gridEl = document.getElementById('grid');

    const viewer = document.getElementById('viewer');
    const viewerHeading = document.getElementById('viewerHeading');

    const closeBtn = document.getElementById('closeBtn');
    const prevBtn = document.getElementById('prevBtn');   // spread prev
    const nextBtn = document.getElementById('nextBtn');   // spread next
    const edgePrev = document.getElementById('edgePrev');
    const edgeNext = document.getElementById('edgeNext');

    edgePrev.addEventListener('click', (e) => {
      if (e.shiftKey) loadPiece(currentIndex - 1);
      else prevSpread();
    });
    edgeNext.addEventListener('click', (e) => {
      if (e.shiftKey) loadPiece(currentIndex + 1);
      else nextSpread();
    });



    const piecePrevBtn = document.getElementById('piecePrev'); // piece prev
    const pieceNextBtn = document.getElementById('pieceNext'); // piece next

    const canvasLeft = document.getElementById('canvasLeft');
    const canvasRight = document.getElementById('canvasRight');
    const blankLeft = document.getElementById('blankLeft');
    const blankRight = document.getElementById('blankRight');

    // State
    let items = [];           // [{file, title, url}]
    let currentIndex = 0;     // which score
    let pdfDoc = null;        // current PDFDocumentProxy
    let leftPage = 1;         // left page number for current spread
    let scale = 1.0;          // zoom scale (relative to "fit")

    // Helpers
    function friendlyTitle(name) {
      let base = name.replace(/\.[^/.]+$/, '');
      base = base.replace(/[_]+/g, ' ').replace(/\s{2,}/g, ' ').trim();
      base = base.replace(/\s*\(full\s*score\)\s*/i, ' (Full Score)');
      base = base.replace(/\bfull\s*score\b/ig, 'Full Score');
      return base;
    }

    function buildCard(item, index) {
      const card = document.createElement('div');
      card.className = 'card';

      const thumb = document.createElement('div');
      thumb.className = 'thumb';

      const emb = document.createElement('embed');
      emb.src = `${item.url}#page=1&view=FitH`;
      emb.type = 'application/pdf';
      thumb.appendChild(emb);

      const overlay = document.createElement('div');
      overlay.className = 'overlay';
      overlay.addEventListener('click', () => openViewer(index));
      thumb.appendChild(overlay);

      const caption = document.createElement('div');
      caption.className = 'title-caption';
      caption.textContent = item.title;

      card.appendChild(thumb);
      card.appendChild(caption);
      return card;
    }

    function renderGrid() {
      gridEl.innerHTML = '';
      items.forEach((it, i) => gridEl.appendChild(buildCard(it, i)));
    }

    // Book layout helpers
    function setSpreadStart(pageNum) {
      if (pageNum <= 1) { leftPage = 0; }           // cover: only right page = 1
      else if (pageNum % 2 === 0) { leftPage = pageNum; } // even left
      else { leftPage = pageNum - 1; }                      // odd -> pair with previous even
    }

    function computeFitScale(viewport, targetCanvas) {
      const maxW = targetCanvas.parentElement.clientWidth;
      const maxH = targetCanvas.parentElement.clientHeight;
      const sW = maxW / viewport.width;
      const sH = maxH / viewport.height;
      return Math.min(sW, sH);
    }

    async function renderPageToCanvas(pdf, pageNumber, canvas, blankDiv) {
      if (pageNumber <= 0 || pageNumber > pdf.numPages) {
        const ctx = canvas.getContext('2d');
        if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.hidden = true;
        blankDiv.hidden = false;
        blankDiv.textContent = ''; // keep white
        return;
      }
      const page = await pdf.getPage(pageNumber);

      const viewport1x = page.getViewport({ scale: 1 });
      const fit = computeFitScale(viewport1x, canvas);
      const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
      const finalScale = fit * scale * dpr;

      const vp = page.getViewport({ scale: finalScale });
      const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
      canvas.width = Math.floor(vp.width);
      canvas.height = Math.floor(vp.height);

      const cssScale = 1 / dpr;
      canvas.style.width = Math.floor(vp.width * cssScale) + 'px';
      canvas.style.height = Math.floor(vp.height * cssScale) + 'px';

      ctx.imageSmoothingEnabled = false;

      await page.render({ canvasContext: ctx, viewport: vp, intent: 'display' }).promise;
      canvas.hidden = false;
      blankDiv.hidden = true;
    }

    async function renderSpread() {
      if (!pdfDoc) return;
      const leftNum = (leftPage === 0) ? 0 : leftPage;
      const rightNum = (leftPage === 0) ? 1 : leftPage + 1;

      await Promise.all([
        renderPageToCanvas(pdfDoc, leftNum, canvasLeft, blankLeft),
        renderPageToCanvas(pdfDoc, rightNum, canvasRight, blankRight),
      ]);
    }

    // replace loadPiece with:
    async function loadPiece(index) {
      currentIndex = (index + items.length) % items.length;
      scale = 1.0;

      // Force cover spread now: left blank, right will become page 1
      leftPage = 0;
      canvasLeft.hidden = true;         // hide any old left page immediately
      blankLeft.hidden = false;         // show the white blank instantly
      blankLeft.textContent = '';

      const it = items[currentIndex];
      viewerHeading.textContent = it.title;

      pdfDoc = await pdfjsLib.getDocument(it.url).promise;
      await renderSpread();             // right becomes page 1
    }



    async function openViewer(index) {
      if (!viewer.open) viewer.showModal();
      await loadPiece(index);
    }

    function closeViewer() {
      if (viewer.open) viewer.close();
      [canvasLeft, canvasRight].forEach(c => {
        const ctx = c.getContext('2d'); ctx && ctx.clearRect(0, 0, c.width, c.height);
      });
      pdfDoc = null;
    }

    // Spread navigation
    function nextSpread() {
      if (leftPage === 0) leftPage = 2; else leftPage += 2;
      renderSpread();
    }
    function prevSpread() {
      if (leftPage === 0) return;
      if (leftPage === 2) leftPage = 0; else leftPage = Math.max(2, leftPage - 2);
      renderSpread();
    }

    // Events
    closeBtn.addEventListener('click', closeViewer);
    nextBtn.addEventListener('click', nextSpread);
    prevBtn.addEventListener('click', prevSpread);

    pieceNextBtn.addEventListener('click', () => loadPiece(currentIndex + 1));
    piecePrevBtn.addEventListener('click', () => loadPiece(currentIndex - 1));

    viewer.addEventListener('click', (e) => { if (e.target === viewer) closeViewer(); });

    window.addEventListener('keydown', (e) => {
      if (!viewer.open) return;
      if (e.key === 'Escape') closeViewer();

      // Spread nav
      if (e.key === 'ArrowRight' && !e.shiftKey) nextSpread();
      if (e.key === 'ArrowLeft' && !e.shiftKey) prevSpread();

      // Piece nav with Shift + Arrow
      if (e.key === 'ArrowRight' && e.shiftKey) loadPiece(currentIndex + 1);
      if (e.key === 'ArrowLeft' && e.shiftKey) loadPiece(currentIndex - 1);

      // Zoom
      if (e.key === '+') { scale = Math.min(3, scale + 0.1); renderSpread(); }
      if (e.key === '-') { scale = Math.max(0.3, scale - 0.1); renderSpread(); }
    });

    window.addEventListener('resize', () => { if (viewer.open) renderSpread(); });

    // Load list of scores
    async function init() {
      try {
        const res = await fetch('scores.json');
        const data = await res.json();
        items = (data.scores || []).map(file => ({
          file,
          title: friendlyTitle(file),
          url: `scores/${encodeURI(file)}`
        }));
        renderGrid();
      } catch (err) {
        gridEl.innerHTML = '<p style="color:#300;padding:1rem;background:rgba(255,255,255,.25);border-radius:8px;">Could not load scores.json.</p>';
        console.error(err);
      }
    }
    init();
  </script>
</body>

</html>